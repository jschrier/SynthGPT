(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 14.0' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[     11421,        312]
NotebookOptionsPosition[      9317,        271]
NotebookOutlinePosition[      9714,        287]
CellTagsIndexPosition[      9671,        284]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{
Cell[BoxData[{
 RowBox[{
  RowBox[{"SetDirectory", "@", 
   RowBox[{"NotebookDirectory", "[", "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"<<", "\"\<./src/gpt_queries.wl\>\""}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"<<", "\"\<./src/string_formatting.wl\>\""}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"{", 
     RowBox[{"train", ",", "test"}], "}"}], "=", 
    RowBox[{"Values", "@", 
     RowBox[{"Import", "[", "\"\<./data/cv_random1.json\>\"", "]"}]}]}], 
   ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"prompt", "=", "\[IndentingNewLine]", 
   RowBox[{"With", "[", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"allowedPrecursors", "=", 
       RowBox[{"StringRiffle", "@", 
        RowBox[{"Keys", "@", 
         RowBox[{"Import", "[", 
          RowBox[{"\"\<./data/precursors.json\>\"", ",", "\"\<RawJSON\>\""}], 
          "]"}]}]}]}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"StringReplace", "[", 
       RowBox[{"\"\<[[ALLOWED PRECURSORS]]\>\"", "->", "allowedPrecursors"}], 
       "]"}], "@", "\[IndentingNewLine]", 
      RowBox[{"Import", "[", "\"\<./prompts/base_prompt.txt\>\"", "]"}]}]}], 
    "]"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.92000732686131*^9, 3.920007332853053*^9}, {
  3.920408994421076*^9, 
  3.920408994624487*^9}},ExpressionUUID->"28a7069e-0565-4405-b54b-\
3a15ec2fde15"],

Cell[BoxData[
 RowBox[{
  RowBox[{"session", "=", 
   RowBox[{"setupChat", "[", 
    RowBox[{"prompt", ",", " ", "0", ",", " ", "\"\<gpt-4-0125-preview\>\""}],
     "]"}]}], ";"}]], "Input",
 CellChangeTimes->{3.920007347920562*^9, 3.920007427519164*^9, 
  3.920007528851884*^9},
 CellLabel->
  "In[1597]:=",ExpressionUUID->"c928a5ce-5231-4af7-8150-75dbc458d590"],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{
  RowBox[{"top1gpt4", "=", 
   RowBox[{"ParallelMap", "[", " ", 
    RowBox[{"(*", 
     RowBox[{
     "insert", " ", "pause", " ", "to", " ", "avoid", " ", "rate", " ", 
      "limit"}], "*)"}], "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"(", 
       RowBox[{
        RowBox[{"Pause", "[", "0.8", "]"}], ";", 
        RowBox[{
         RowBox[{"evaluateTop1", "[", "session", "]"}], "[", "#", "]"}]}], 
       ")"}], "&"}], ",", "\[IndentingNewLine]", "test", ",", 
     RowBox[{"ProgressReporting", "->", "True"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{"N", "@", 
  RowBox[{"Mean", "@", 
   RowBox[{"Boole", "@", 
    RowBox[{
     RowBox[{"Lookup", "[", "\"\<correct\>\"", "]"}], "@", 
     "%"}]}]}]}]}], "Input",
 CellChangeTimes->{{3.920007459867918*^9, 3.920007461760702*^9}, {
  3.920007649901263*^9, 3.920007652668857*^9}},
 CellLabel->
  "In[1602]:=",ExpressionUUID->"ec4b5358-2d52-4368-9271-6b607e672197"],

Cell[BoxData["0.39971550497866287`"], "Output",
 CellChangeTimes->{3.92000982325334*^9},
 CellLabel->
  "Out[1603]=",ExpressionUUID->"7b2952bb-c5ba-43d5-9362-021543460768"]
}, Open  ]],

Cell[TextData[{
 StyleBox["Comment:  ",
  FontWeight->"Bold"],
 "This cost $26 just for the top-1.  Results are kind of lackluster."
}], "Text",
 CellChangeTimes->{{3.9200102418458652`*^9, 
  3.920010273071403*^9}},ExpressionUUID->"b97c672f-ea0e-4303-89bb-\
eb14e99e2846"],

Cell[TextData[{
 StyleBox["Question:  ",
  FontWeight->"Bold"],
 "Do we really want to include O2 as a reactant?  "
}], "Text",
 CellChangeTimes->{{3.920010333377022*^9, 
  3.920010343670393*^9}},ExpressionUUID->"8fea6630-faf3-4f6f-8bee-\
f1e283b9236c"],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{"test", "[", 
  RowBox[{"[", "300", "]"}], "]"}], "\[IndentingNewLine]", 
 RowBox[{"top1gpt4", "[", 
  RowBox[{"[", "300", "]"}], "]"}]}], "Input",
 CellChangeTimes->{{3.9200103180820627`*^9, 3.920010348951256*^9}},
 CellLabel->
  "In[1639]:=",ExpressionUUID->"67e6d601-b07d-4de9-b6ef-44ca59335c7b"],

Cell[BoxData[
 RowBox[{"\<\"CeTbO3\"\>", "\[Rule]", 
  RowBox[{"{", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"\<\"Tb4O7\"\>", ",", "\<\"CeO2\"\>"}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{"\<\"Tb4O7\"\>", ",", "\<\"CeO2\"\>"}], "}"}]}], 
   "}"}]}]], "Output",
 CellChangeTimes->{{3.920010320435453*^9, 3.920010349440752*^9}},
 CellLabel->
  "Out[1639]=",ExpressionUUID->"0c020570-fb8a-45d1-9514-47b6ed887fd4"],

Cell[BoxData[
 RowBox[{"\[LeftAssociation]", 
  RowBox[{
   RowBox[{"\<\"correct\"\>", "\[Rule]", "False"}], ",", 
   RowBox[{"\<\"input\"\>", "\[Rule]", "\<\"synthesize CeTbO3\"\>"}], ",", 
   RowBox[{"\<\"output\"\>", 
    "\[Rule]", "\<\"CeTbO3 <- CeO2 + Tb4O7 + O2\"\>"}]}], 
  "\[RightAssociation]"}]], "Output",
 CellChangeTimes->{{3.920010320435453*^9, 3.92001034944573*^9}},
 CellLabel->
  "Out[1640]=",ExpressionUUID->"7133aa0a-0f75-4904-8dfd-41023a40b697"]
}, Open  ]],

Cell["Sometimes we get it right anyway...", "Text",
 CellChangeTimes->{{3.920010382671332*^9, 3.9200103881825933`*^9}, {
  3.92001247572189*^9, 
  3.920012494566038*^9}},ExpressionUUID->"c98ab4a5-bc08-446a-8154-\
f7004a322170"],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{"test", "[", 
  RowBox[{"[", "301", "]"}], "]"}], "\[IndentingNewLine]", 
 RowBox[{"top1gpt4", "[", 
  RowBox[{"[", "301", "]"}], "]"}]}], "Input",
 CellChangeTimes->{{3.9200103534381733`*^9, 3.92001036561449*^9}},
 CellLabel->
  "In[1642]:=",ExpressionUUID->"24b12dc0-3d55-4c84-b69b-9684bc9f7aa1"],

Cell[BoxData[
 RowBox[{"\<\"La0.2Ba0.8Co0.8Fe0.156Zr0.044O3\"\>", "\[Rule]", 
  RowBox[{"{", 
   RowBox[{"{", 
    RowBox[{"\<\"La2O3\"\>", ",", "\<\"Fe2O3\"\>", ",", "\<\"BaCO3\"\>", 
     ",", "\<\"ZrO2\"\>", ",", "\<\"Co3O4\"\>", ",", "\<\"O2\"\>"}], "}"}], 
   "}"}]}]], "Output",
 CellChangeTimes->{{3.920010357836557*^9, 3.920010366434224*^9}},
 CellLabel->
  "Out[1642]=",ExpressionUUID->"75e5abb9-e5cb-4d02-97a1-c9990873ccd5"],

Cell[BoxData[
 RowBox[{"\[LeftAssociation]", 
  RowBox[{
   RowBox[{"\<\"correct\"\>", "\[Rule]", "True"}], ",", 
   RowBox[{"\<\"input\"\>", 
    "\[Rule]", "\<\"synthesize La0.2Ba0.8Co0.8Fe0.156Zr0.044O3\"\>"}], ",", 
   RowBox[{"\<\"output\"\>", 
    "\[Rule]", "\<\"La0.2Ba0.8Co0.8Fe0.156Zr0.044O3 <- La2O3 + BaCO3 + Co3O4 \
+ Fe2O3 + ZrO2 + O2\"\>"}]}], "\[RightAssociation]"}]], "Output",
 CellChangeTimes->{{3.920010357836557*^9, 3.9200103664385242`*^9}},
 CellLabel->
  "Out[1643]=",ExpressionUUID->"885b1305-6731-4bc6-9cc5-89a2f686890a"]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[""], "Input",
 CellChangeTimes->{{3.9200098984697123`*^9, 3.920009920436946*^9}, {
   3.920010292226346*^9, 3.9200103097410097`*^9}, 
   3.920010347868004*^9},ExpressionUUID->"84126f81-a7e1-4e8c-abd0-\
d951169e758b"],

Cell[BoxData[
 RowBox[{"\[LeftAssociation]", 
  RowBox[{
   RowBox[{"\<\"correct\"\>", "\[Rule]", "False"}], ",", 
   RowBox[{"\<\"input\"\>", "\[Rule]", "\<\"synthesize CeTbO3\"\>"}], ",", 
   RowBox[{"\<\"output\"\>", 
    "\[Rule]", "\<\"CeTbO3 <- CeO2 + Tb4O7 + O2\"\>"}]}], 
  "\[RightAssociation]"}]], "Output",
 CellChangeTimes->{{3.920009907936314*^9, 3.920009920845459*^9}, {
  3.920010293070965*^9, 3.920010310163247*^9}},
 CellLabel->
  "Out[1637]=",ExpressionUUID->"6db0d1b7-ae04-49d6-b243-e20562b37429"]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{
  RowBox[{"top5gpt4", "=", 
   RowBox[{"ParallelMap", "[", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"(", 
       RowBox[{
        RowBox[{"Pause", "[", "0.8", "]"}], ";", 
        RowBox[{
         RowBox[{"evaluateTop5", "[", "session", "]"}], "[", "#", "]"}]}], 
       ")"}], "&"}], ",", "\[IndentingNewLine]", "test", ",", 
     RowBox[{"ProgressReporting", "->", "True"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{"N", "@", 
  RowBox[{"Mean", "@", 
   RowBox[{"Boole", "@", 
    RowBox[{
     RowBox[{"Lookup", "[", "\"\<correct\>\"", "]"}], "@", 
     "%"}]}]}]}]}], "Input",
 CellChangeTimes->{{3.92000748948197*^9, 3.9200074907554398`*^9}, {
  3.920007674440579*^9, 3.920007675371336*^9}, {3.920009506109116*^9, 
  3.9200095065102587`*^9}, {3.920009596234412*^9, 3.920009596846887*^9}, {
  3.920009631204961*^9, 3.920009637676745*^9}},
 CellLabel->
  "In[1644]:=",ExpressionUUID->"d2b625e2-23bf-49b7-82b9-ef742258a322"],

Cell[BoxData["0.510194404931247`"], "Output",
 CellChangeTimes->{3.9200164789625*^9},
 CellLabel->
  "Out[1645]=",ExpressionUUID->"f5f7ed73-f0e1-4791-8041-ba02acb62eb4"]
}, Open  ]],

Cell[BoxData[
 RowBox[{
  RowBox[{"DumpSave", "[", 
   RowBox[{"\"\<gpt4_checkpoint_cv1.mx\>\"", ",", 
    RowBox[{"{", 
     RowBox[{"top1gpt4", ",", "top5gpt4"}], "}"}]}], "]"}], ";"}]], "Input",
 CellChangeTimes->{{3.920007483719721*^9, 3.920007484767352*^9}, {
  3.920009603373787*^9, 3.920009607666675*^9}},
 CellLabel->
  "In[1646]:=",ExpressionUUID->"140f45a9-ccfa-4d36-b2e3-f353f23aa9eb"]
},
WindowSize->{808, 747},
WindowMargins->{{Automatic, 88}, {Automatic, 16}},
FrontEndVersion->"14.0 for Mac OS X x86 (64-bit) (December 12, 2023)",
StyleDefinitions->"Default.nb",
ExpressionUUID->"3e876154-ef95-4a2c-9960-7938d26263d8"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[558, 20, 1460, 36, 241, "Input",ExpressionUUID->"28a7069e-0565-4405-b54b-3a15ec2fde15"],
Cell[2021, 58, 363, 9, 30, "Input",ExpressionUUID->"c928a5ce-5231-4af7-8150-75dbc458d590"],
Cell[CellGroupData[{
Cell[2409, 71, 979, 27, 94, "Input",ExpressionUUID->"ec4b5358-2d52-4368-9271-6b607e672197"],
Cell[3391, 100, 172, 3, 34, "Output",ExpressionUUID->"7b2952bb-c5ba-43d5-9362-021543460768"]
}, Open  ]],
Cell[3578, 106, 272, 7, 35, "Text",ExpressionUUID->"b97c672f-ea0e-4303-89bb-eb14e99e2846"],
Cell[3853, 115, 253, 7, 35, "Text",ExpressionUUID->"8fea6630-faf3-4f6f-8bee-f1e283b9236c"],
Cell[CellGroupData[{
Cell[4131, 126, 323, 7, 52, "Input",ExpressionUUID->"67e6d601-b07d-4de9-b6ef-44ca59335c7b"],
Cell[4457, 135, 418, 11, 34, "Output",ExpressionUUID->"0c020570-fb8a-45d1-9514-47b6ed887fd4"],
Cell[4878, 148, 466, 10, 34, "Output",ExpressionUUID->"7133aa0a-0f75-4904-8dfd-41023a40b697"]
}, Open  ]],
Cell[5359, 161, 227, 4, 35, "Text",ExpressionUUID->"c98ab4a5-bc08-446a-8154-f7004a322170"],
Cell[CellGroupData[{
Cell[5611, 169, 322, 7, 52, "Input",ExpressionUUID->"24b12dc0-3d55-4c84-b69b-9684bc9f7aa1"],
Cell[5936, 178, 434, 9, 34, "Output",ExpressionUUID->"75e5abb9-e5cb-4d02-97a1-c9990873ccd5"],
Cell[6373, 189, 546, 11, 56, "Output",ExpressionUUID->"885b1305-6731-4bc6-9cc5-89a2f686890a"]
}, Open  ]],
Cell[CellGroupData[{
Cell[6956, 205, 229, 4, 30, "Input",ExpressionUUID->"84126f81-a7e1-4e8c-abd0-d951169e758b"],
Cell[7188, 211, 516, 11, 34, "Output",ExpressionUUID->"6db0d1b7-ae04-49d6-b243-e20562b37429"]
}, Open  ]],
Cell[CellGroupData[{
Cell[7741, 227, 989, 25, 94, "Input",ExpressionUUID->"d2b625e2-23bf-49b7-82b9-ef742258a322"],
Cell[8733, 254, 169, 3, 34, "Output",ExpressionUUID->"f5f7ed73-f0e1-4791-8041-ba02acb62eb4"]
}, Open  ]],
Cell[8917, 260, 396, 9, 30, "Input",ExpressionUUID->"140f45a9-ccfa-4d36-b2e3-f353f23aa9eb"]
}
]
*)

